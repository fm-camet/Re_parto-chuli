<!DOCTYPE html><html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reparto Chuli</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 70vh; width: 100%; }
    .controls { padding: 10px; }
    .controls input, .controls button { padding: 10px; margin: 5px 0; width: 100%; font-size: 16px; }
    .destinos-lista { padding: 10px; font-size: 14px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="controls">
    <input type="text" id="destino" placeholder="Agregar dirección" />
    <button onclick="agregarDestino()">Agregar destino</button>
    <button onclick="optimizarRuta()">Optimizar ruta</button>
    <button onclick="limpiarDestinos()">Limpiar destinos</button>
  </div>
  <div class="destinos-lista" id="listaDestinos"></div>  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>  <script>
    const apiKey = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjAyNjY4YmE3NTkyMzQ5OGJiNGRkYjA2OTI0YTM3MGQ1IiwiaCI6Im11cm11cjY0In0=";
    let map = L.map('map');
    let destinos = [];
    let markers = [];
    let rutaLayer = null;
    let ubicacionActual = null;

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        ubicacionActual = [latitude, longitude];
        map.setView(ubicacionActual, 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19
        }).addTo(map);
        L.marker(ubicacionActual).addTo(map).bindPopup("Mi ubicación actual").openPopup();
      }, () => alert("No se pudo obtener la ubicación."));
    }

    function agregarDestino() {
      const direccion = document.getElementById("destino").value;
      if (!direccion) return;

      fetch(`https://api.openrouteservice.org/geocode/search?api_key=${apiKey}&text=${direccion}`)
        .then(res => res.json())
        .then(data => {
          const coords = data.features[0].geometry.coordinates;
          const latlng = [coords[1], coords[0]];
          destinos.push({ direccion, coords: latlng });
          const marker = L.marker(latlng).addTo(map).bindPopup(direccion);
          markers.push(marker);
          actualizarLista();
        })
        .catch(() => alert("No se pudo geocodificar la dirección."));
    }

    function actualizarLista() {
      const lista = document.getElementById("listaDestinos");
      lista.innerHTML = destinos.map((d, i) => `${i + 1}. ${d.direccion}`).join("<br>");
    }

    function optimizarRuta() {
      if (!ubicacionActual || destinos.length === 0) return alert("Agregá al menos un destino.");

      const locations = [ubicacionActual, ...destinos.map(d => d.coords)].map(p => [p[1], p[0]]);

      fetch("https://api.openrouteservice.org/optimization", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": apiKey
        },
        body: JSON.stringify({
          jobs: destinos.map((d, i) => ({
            id: i + 1,
            location: [d.coords[1], d.coords[0]]
          })),
          vehicles: [{
            id: 1,
            profile: "driving-car",
            start: [ubicacionActual[1], ubicacionActual[0]]
          }]
        })
      })
      .then(res => res.json())
      .then(data => {
        const route = data.routes[0].steps.map(s => destinos[s.job - 1].coords);
        if (rutaLayer) map.removeLayer(rutaLayer);
        rutaLayer = L.polyline([ubicacionActual, ...route], { color: 'blue' }).addTo(map);
      })
      .catch(() => alert("No se pudo optimizar la ruta."));
    }

    function limpiarDestinos() {
      destinos = [];
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      if (rutaLayer) map.removeLayer(rutaLayer);
      document.getElementById("listaDestinos").innerHTML = "";
    }
  </script></body>
</html>
