list.appendChild(li);
const m = L.marker([s.lat, s.lng], { icon: makeNumberIcon(i + 1) }).addTo(map).bindPopup(`${i + 1}. ${s.address}`);
markers.push(m);
});
}

/* Geocodifica direcci贸n -> agrega stop */
async function addStopFromAddress(address) {
  if (!address) {
    alert('Ingres谩 una direcci贸n');
    return;
  }
  if (stops.length >= MAX_STOPS) {
    alert('M谩ximo ' + MAX_STOPS + ' destinos');
    return;
  }

  // Verificar si la direcci贸n ya existe
  if (stops.some(stop => stop.address.toLowerCase() === address.toLowerCase())) {
    alert('Esta direcci贸n ya ha sido agregada.');
    return;
  }

  try {
    const url = `https://api.openrouteservice.org/geocode/search?api_key=${ORS_API_KEY}&text=${encodeURIComponent(address)}&size=1`;
    const r = await fetch(url);
    const j = await r.json();

    if (!j.features || j.features.length === 0) throw new Error('no encontrado');

    const [lon, lat] = j.features[0].geometry.coordinates;

    // Verificar si las coordenadas ya est谩n en la lista de paradas
    if (stops.some(stop => stop.lat === lat && stop.lng === lon)) {
      alert('Esta ubicaci贸n ya ha sido agregada.');
      return;
    }

    stops.push({ address: address, lat: lat, lng: lon });
    refreshStopsUI();

    // Si tenemos ubicaci贸n del usuario, ordenar autom谩ticamente y trazar
    if (userPos) {
      sortStopsByProximity();
      await drawRouteAuto();
    }
  } catch (e) {
    console.error(e);
    alert('Direcci贸n no encontrada.');
  }
}

/* usar geolocalizaci贸n */
function useMyLocation() {
  if (!navigator.geolocation) { alert('No hay geolocalizaci贸n'); return; }
  navigator.geolocation.getCurrentPosition(p => {
    userPos = [p.coords.latitude, p.coords.longitude];
    const m = L.circleMarker(userPos, { radius: 8, color: '#2e7d32', fill: true }).addTo(map).bindPopup('Tu ubicaci贸n').openPopup();
    map.setView(userPos, 14);
    refreshStopsUI();
  }, err => {
    alert('Error geolocalizaci贸n: ' + err.message);
  }, { enableHighAccuracy: true, timeout: 10000 });
}

/* ordenar localmente por cercan铆a desde userPos */
function sortStopsByProximity() {
  if (!userPos) { alert('Activa ubicaci贸n primero ( Mi ubicaci贸n)'); return; }
  stops.sort((a, b) => haversine(userPos, [a.lat, a.lng]) - haversine(userPos, [b.lat, b.lng]));
  refreshStopsUI();
}

/* traza ruta llamando ORS directions una vez (userPos -> stops...) */
async function drawRouteOrdered(coordsLatLng) {
  if (coordsLatLng.length < 2) return;
  const coordsLonLat = coordsLatLng.map(c => [c[1], c[0]]); // lon,lat
  const body = { coordinates: coordsLonLat };
  try {
    const res = await fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson', {
      method: 'POST',
      headers: { 'Authorization': ORS_API_KEY, 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const geo = await res.json();
    if (routeLayer) map.removeLayer(routeLayer);
    routeLayer = L.geoJSON(geo, { style: { color: '#1976d2', weight: 4 } }).addTo(map);
    map.fitBounds(routeLayer.getBounds(), { padding: [40, 40] });
  } catch (e) {
    console.error(e);
    alert('Error trazando ruta.');
  }
}

/* ordena localmente y luego traza (flujo autom谩tico) */
async function drawRouteAuto() {
  if (!userPos) { console.warn('sin userPos'); return; }
  if (stops.length === 0) return;
  sortStopsByProximity();
  const coords = [userPos, ...stops.map(s => [s.lat, s.lng])];
  await drawRouteOrdered(coords);
}

/* invertir manteniendo inicio = userPos */
async function invertOrder() {
  stops.reverse();
  refreshStopsUI();
  if (userPos) await drawRouteOrdered([userPos, ...stops.map(s => [s.lat, s.lng])]);
}

/* limpiar todo */
function clearAll() {
  stops = [];
  markers.forEach(m => map.removeLayer(m));
  markers = [];
  if (routeLayer) map.removeLayer(routeLayer);
  routeLayer = null;
  document.getElementById('stops').innerHTML = '';
}

/* eventos UI */
document.getElementById('btn-loc').onclick = useMyLocation;
document.getElementById('btn-add').onclick = () => addStopFromAddress(document.getElementById('addr').value.trim());
document.getElementById('btn-invert').onclick = invertOrder;
document.getElementById('btn-clear').onclick = clearAll;
document.getElementById('btn-opt').onclick = drawRouteAuto;
document.getElementById('addr').addEventListener('keypress', e => { if (e.key === 'Enter') addStopFromAddress(e.target.value.trim()); });

</script>
</body>
</html>
