<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Reparto Chuli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 60vh; }
    body { font-family: Arial; padding: 0; margin: 0; }
    #controls { padding: 10px; }
    input, button { margin: 4px; padding: 6px; }
  </style>
</head>
<body>

<h3 style="text-align:center;">Reparto Chuli - Ruta Optimizada</h3>
<div id="map"></div>
<div id="controls">
  <input type="text" id="addressInput" placeholder="Ingresar destino">
  <button onclick="addDestination()">Agregar</button>
  <button onclick="optimizeRoute()">Optimizar Ruta</button>
  <ul id="destList"></ul>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const apiKey = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjAyNjY4YmE3NTkyMzQ5OGJiNGRkYjA2OTI0YTM3MGQ1IiwiaCI6Im11cm11cjY0In0=";
let map = L.map("map").setView([-38, -57.5], 13);
let userMarker, routeLayer;
let destinations = [];
let markers = [];
let userCoords = null;

// Cargar mapa base
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

// Geolocalización
navigator.geolocation.getCurrentPosition(pos => {
  userCoords = [pos.coords.latitude, pos.coords.longitude];
  userMarker = L.marker(userCoords).addTo(map).bindPopup("Tu ubicación").openPopup();
  map.setView(userCoords, 14);
}, err => alert("No se pudo obtener ubicación"));

async function addDestination() {
  if (destinations.length >= 8) {
    alert("Máximo 8 destinos");
    return;
  }
  const address = document.getElementById("addressInput").value.trim();
  if (!address) return;
  const url = `https://api.openrouteservice.org/geocode/search?api_key=${apiKey}&text=${encodeURIComponent(address)}`;
  const res = await fetch(url);
  const data = await res.json();
  if (!data.features.length) return alert("Dirección no encontrada");
  const [lng, lat] = data.features[0].geometry.coordinates;
  destinations.push([lat, lng]);
  const m = L.marker([lat, lng]).addTo(map).bindPopup(address);
  markers.push(m);
  const li = document.createElement("li");
  li.textContent = address;
  document.getElementById("destList").appendChild(li);
  document.getElementById("addressInput").value = "";
}

async function optimizeRoute() {
  if (!userCoords || destinations.length === 0) return alert("Ubicación o destinos faltantes");

  const jobs = destinations.map((d, i) => ({
    id: i + 1,
    location: [d[1], d[0]]
  }));
  const vehicle = {
    id: 1,
    start: [userCoords[1], userCoords[0]],
    capacity: [100],
    time_window: [0, 32400]
  };

  const body = { jobs, vehicles: [vehicle] };
  const optRes = await fetch("https://api.openrouteservice.org/optimization", {
    method: "POST",
    headers: {
      "Authorization": apiKey,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(body)
  });
  const optData = await optRes.json();
  const steps = optData.routes[0].steps.filter(s => s.type === "job");
  const coordsOrdered = [userCoords, ...steps.map(s => destinations[s.job - 1])];

  const dirRes = await fetch("https://api.openrouteservice.org/v2/directions/driving-car/geojson", {
    method: "POST",
    headers: {
      "Authorization": apiKey,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ coordinates: coordsOrdered.map(c => [c[1], c[0]]) })
  });
  const geojson = await dirRes.json();
  if (routeLayer) map.removeLayer(routeLayer);
  routeLayer = L.geoJSON(geojson, { style: { color: "blue", weight: 5 } }).addTo(map);
  map.fitBounds(routeLayer.getBounds(), { padding: [20, 20] });
}
</script>
</body>
</html>
