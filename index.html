<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Rutas con ORS y Fallback</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 500px; }
  </style>
</head>
<body>

<div>
  <input id="addr" placeholder="DirecciÃ³n..." />
  <button id="btn-add">Agregar</button>
  <button id="btn-loc">ğŸ“ Mi ubicaciÃ³n</button>
  <button id="btn-opt">Optimizar ruta</button>
  <button id="btn-invert">Invertir</button>
  <button id="btn-clear">Limpiar</button>
</div>
<ul id="stops"></ul>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* CONFIG */
const ORS_API_KEY = "TU_API_KEY_AQUI"; // â† Pega tu API aquÃ­
const MAX_STOPS = 10;

/* VARIABLES */
let map = L.map('map').setView([-38.0055, -57.5426], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);

let stops = [];
let markers = [];
let routeLayer = null;
let userPos = null;

/* FUNCIONES DE GEOCODIFICACIÃ“N */
async function geocodeORS(address) {
  try {
    const url = `https://api.openrouteservice.org/geocode/search?api_key=${ORS_API_KEY}&text=${encodeURIComponent(address + ', Mar del Plata, Argentina')}&boundary.country=AR&size=1`;
    const r = await fetch(url);
    const j = await r.json();
    if (!j.features || j.features.length === 0) return null;
    const [lon, lat] = j.features[0].geometry.coordinates;
    const displayName = j.features[0].properties.label || address;
    return { lat, lon, displayName };
  } catch {
    return null;
  }
}

async function geocodeNominatim(address) {
  try {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Mar del Plata, Argentina')}&limit=1&addressdetails=1`;
    const r = await fetch(url, { headers: { 'User-Agent': 'LeafletApp/1.0' } });
    const j = await r.json();
    if (!j || j.length === 0) return null;
    const lat = parseFloat(j[0].lat);
    const lon = parseFloat(j[0].lon);
    const displayName = j[0].display_name || address;
    return { lat, lon, displayName };
  } catch {
    return null;
  }
}

/* Geocodifica direcciÃ³n -> agrega stop (ORS + fallback Nominatim) */
async function addStopFromAddress(address) {
  if (!address) { alert('IngresÃ¡ una direcciÃ³n'); return; }
  if (stops.length >= MAX_STOPS) { alert('MÃ¡ximo ' + MAX_STOPS + ' destinos'); return; }

  try {
    let result = await geocodeORS(address);
    if (!result) {
      console.warn('ORS no encontrÃ³ resultado, probando Nominatim...');
      result = await geocodeNominatim(address);
    }

    if (!result) {
      alert('DirecciÃ³n no encontrada en ningÃºn servicio.');
      return;
    }

    const { lat, lon, displayName } = result;
    const exists = stops.some(s => s.lat === lat && s.lng === lon);
    if (exists) {
      alert('Ese destino ya fue agregado.');
      return;
    }

    stops.push({ address: displayName, lat, lng: lon });
    refreshStopsUI();

    if (userPos) {
      sortStopsByProximity();
      await drawRouteAuto();
    }
  } catch (e) {
    console.error(e);
    alert('Error procesando la direcciÃ³n.');
  }
}

/* UI de stops */
function refreshStopsUI() {
  const list = document.getElementById('stops');
  list.innerHTML = '';
  markers.forEach(m => map.removeLayer(m));
  markers = [];
  stops.forEach((s, i) => {
    const li = document.createElement('li');
    li.textContent = `${i+1}. ${s.address}`;
    list.appendChild(li);
    const m = L.marker([s.lat, s.lng]).addTo(map).bindPopup(`${i+1}. ${s.address}`);
    markers.push(m);
  });
}

/* GeolocalizaciÃ³n */
function useMyLocation() {
  if (!navigator.geolocation) { alert('No hay geolocalizaciÃ³n'); return; }
  navigator.geolocation.getCurrentPosition(p => {
    userPos = [p.coords.latitude, p.coords.longitude];
    L.circleMarker(userPos, { radius: 8, color: '#2e7d32', fill: true }).addTo(map).bindPopup('Tu ubicaciÃ³n').openPopup();
    map.setView(userPos, 14);
    refreshStopsUI();
  }, err => {
    alert('Error geolocalizaciÃ³n: ' + err.message);
  }, { enableHighAccuracy: true, timeout: 10000 });
}

/* Ordenar por proximidad */
function sortStopsByProximity() {
  if (!userPos) { alert('Activa ubicaciÃ³n primero (ğŸ“ Mi ubicaciÃ³n)'); return; }
  stops.sort((a, b) => haversine(userPos, [a.lat, a.lng]) - haversine(userPos, [b.lat, b.lng]));
  refreshStopsUI();
}

/* Haversine */
function haversine(coord1, coord2) {
  const R = 6371e3;
  const rad = x => x * Math.PI / 180;
  const [lat1, lon1] = coord1;
  const [lat2, lon2] = coord2;
  const Ï†1 = rad(lat1), Ï†2 = rad(lat2);
  const Î”Ï† = rad(lat2 - lat1);
  const Î”Î» = rad(lon2 - lon1);
  const a = Math.sin(Î”Ï† / 2) ** 2 + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î» / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

/* Traza ruta */
async function drawRouteOrdered(coordsLatLng) {
  if (coordsLatLng.length < 2) return;
  const coordsLonLat = coordsLatLng.map(c => [c[1], c[0]]);
  const body = { coordinates: coordsLonLat };
  try {
    const res = await fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson', {
      method: 'POST',
      headers: { 'Authorization': ORS_API_KEY, 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const geo = await res.json();
    if (routeLayer) map.removeLayer(routeLayer);
    routeLayer = L.geoJSON(geo, { style: { color: '#1976d2', weight: 4 } }).addTo(map);
    map.fitBounds(routeLayer.getBounds(), { padding: [40, 40] });
  } catch (e) {
    console.error(e);
    alert('Error trazando ruta.');
  }
}

/* Flujo automÃ¡tico */
async function drawRouteAuto() {
  if (!userPos) { console.warn('sin userPos'); return; }
  if (stops.length === 0) return;
  sortStopsByProximity();
  const coords = [userPos, ...stops.map(s => [s.lat, s.lng])];
  await drawRouteOrdered(coords);
}

/* Invertir */
async function invertOrder() {
  stops.reverse();
  refreshStopsUI();
  if (userPos) await drawRouteOrdered([userPos, ...stops.map(s => [s.lat, s.lng])]);
}

/* Limpiar */
function clearAll() {
  stops = [];
  markers.forEach(m => map.removeLayer(m));
  markers = [];
  if (routeLayer) map.removeLayer(routeLayer);
  routeLayer = null;
  document.getElementById('stops').innerHTML = '';
}

/* Eventos UI */
document.getElementById('btn-loc').onclick = useMyLocation;
document.getElementById('btn-add').onclick = () => addStopFromAddress(document.getElementById('addr').value.trim());
document.getElementById('btn-invert').onclick = invertOrder;
document.getElementById('btn-clear').onclick = clearAll;
document.getElementById('btn-opt').onclick = drawRouteAuto;
document.getElementById('addr').addEventListener('keypress', e => {
  if (e.key === 'Enter') addStopFromAddress(e.target.value.trim());
});
</script>
</body>
</html>
