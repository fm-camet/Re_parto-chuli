<!DOCTYPE html><html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reparto Chuli</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #map { height: 70%; }
    #controls { padding: 10px; background: #f0f0f0; }
    input, button { margin: 5px 0; width: 100%; padding: 8px; }
    ol { padding-left: 20px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="controls">
    <input type="text" id="addressInput" placeholder="Agregar direcci칩n" />
    <button onclick="addDestination()">Agregar destino</button>
    <button onclick="optimizeRoute()">Optimizar ruta</button>
    <button onclick="invertRoute()">Invertir orden</button>
    <ol id="destList"></ol>
  </div>  <script>
    const apiKey = 'TU_API_KEY'; // reemplaz치 con tu API Key
    let map = L.map('map').setView([-38.0055, -57.5426], 13);
    let currentPos = null;
    let markers = [];
    let destCoords = [];
    let routeLine = null;

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data &copy; OpenStreetMap contributors'
    }).addTo(map);

    navigator.geolocation.getCurrentPosition(pos => {
      currentPos = [pos.coords.latitude, pos.coords.longitude];
      L.marker(currentPos).addTo(map).bindPopup("Ubicaci칩n actual").openPopup();
      map.setView(currentPos, 13);
    });

    function addDestination() {
      if (markers.length >= 9) return alert("M치ximo 9 destinos");
      const address = document.getElementById("addressInput").value;
      if (!address) return;
      axios.get(`https://api.openrouteservice.org/geocode/search?api_key=${apiKey}&text=${encodeURIComponent(address)}`)
        .then(resp => {
          const coord = resp.data.features[0].geometry.coordinates.reverse();
          destCoords.push(coord);
          const marker = L.marker(coord).addTo(map).bindPopup(address);
          markers.push(marker);
          updateDestList();
        });
    }

    function updateDestList() {
      const list = document.getElementById("destList");
      list.innerHTML = "";
      destCoords.forEach((c, i) => {
        const li = document.createElement("li");
        li.innerText = `Destino ${i + 1}`;
        list.appendChild(li);
      });
    }

    function optimizeRoute() {
      if (!currentPos || destCoords.length === 0) return;
      const locations = [currentPos, ...destCoords];
      axios.post('https://api.openrouteservice.org/v2/matrix/driving-car', {
        locations: locations.map(p => [p[1], p[0]]),
        metrics: ["distance"],
        units: "km"
      }, {
        headers: {
          'Authorization': apiKey,
          'Content-Type': 'application/json'
        }
      }).then(resp => {
        const distances = resp.data.distances[0].slice(1);
        const sorted = distances.map((d, i) => [d, i])
                              .sort((a, b) => a[0] - b[0])
                              .map(d => destCoords[d[1]]);
        destCoords = sorted;
        updateDestList();
        drawRoute();
      });
    }

    function invertRoute() {
      destCoords.reverse();
      updateDestList();
      drawRoute();
    }

    function drawRoute() {
      if (routeLine) map.removeLayer(routeLine);
      const coords = [currentPos, ...destCoords];
      axios.post('https://api.openrouteservice.org/v2/directions/driving-car/geojson', {
        coordinates: coords.map(c => [c[1], c[0]])
      }, {
        headers: { 'Authorization': apiKey }
      }).then(resp => {
        routeLine = L.geoJSON(resp.data, {
          style: { color: 'blue', weight: 4 }
        }).addTo(map);
      });
    }
  </script></body>
</html>
