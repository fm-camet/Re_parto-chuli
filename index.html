<!DOCTYPE html><html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reparto Chuli</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      #map {
        height: 70vh;
        width: 100%;
      }
      .controls {
        padding: 10px;
      }
      .stop-list {
        font-family: sans-serif;
        font-size: 14px;
        padding: 10px;
        background: #f5f5f5;
      }
      .stop-list ul {
        padding-left: 20px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div class="controls">
      <input type="text" id="addressInput" placeholder="Agregar dirección" />
      <button onclick="addAddress()">Agregar</button>
      <button onclick="optimizeRoute()">Optimizar Ruta</button>
      <button onclick="invertirRuta()">Invertir Orden</button>
    </div>
    <div class="stop-list">
      <strong>Paradas:</strong>
      <ul id="stopList"></ul>
    </div><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const apiKey = "tu_api_key_aqui";
  let map = L.map("map").setView([-38.0055, -57.5426], 13);
  let markers = [];
  let coords = [];

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
  }).addTo(map);

  navigator.geolocation.getCurrentPosition((pos) => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    map.setView([lat, lng], 13);
    L.marker([lat, lng]).addTo(map).bindPopup("Tu ubicación").openPopup();
    coords.push([lng, lat]);
  });

  function addAddress() {
    const input = document.getElementById("addressInput");
    const address = input.value;
    if (!address || coords.length >= 10) return;

    fetch(
      `https://api.openrouteservice.org/geocode/search?api_key=${apiKey}&text=${encodeURIComponent(
        address
      )}`
    )
      .then((res) => res.json())
      .then((data) => {
        if (data.features.length > 0) {
          const [lng, lat] = data.features[0].geometry.coordinates;
          coords.push([lng, lat]);
          const marker = L.marker([lat, lng]).addTo(map);
          markers.push(marker);
          updateStopList();
          drawRoute();
        }
      });

    input.value = "";
  }

  function drawRoute() {
    if (coords.length < 2) return;

    const body = {
      coordinates: coords,
    };

    fetch("https://api.openrouteservice.org/v2/directions/driving-car/geojson", {
      method: "POST",
      headers: {
        Authorization: apiKey,
        "Content-Type": "application/json",
      },
      body: JSON.stringify(body),
    })
      .then((res) => res.json())
      .then((data) => {
        if (window.routeLayer) map.removeLayer(window.routeLayer);
        window.routeLayer = L.geoJSON(data).addTo(map);
      });
  }

  function optimizeRoute() {
    if (coords.length < 3) return;

    const jobs = coords.slice(1).map(([lng, lat], i) => ({
      id: i + 1,
      location: [lng, lat],
    }));

    const body = {
      jobs,
      vehicles: [
        {
          id: 1,
          start: coords[0],
          end: coords[coords.length - 1],
        },
      ],
    };

    fetch("https://api.openrouteservice.org/optimization", {
      method: "POST",
      headers: {
        Authorization: apiKey,
        "Content-Type": "application/json",
      },
      body: JSON.stringify(body),
    })
      .then((res) => res.json())
      .then((data) => {
        const ordered = [coords[0]];
        data.routes[0].steps.forEach((step) => {
          if (step.type === "job") ordered.push(jobs[step.id - 1].location);
        });
        coords = ordered;
        markers.forEach((m) => map.removeLayer(m));
        markers = [];
        coords.slice(1).forEach(([lng, lat]) => {
          markers.push(L.marker([lat, lng]).addTo(map));
        });
        updateStopList();
        drawRoute();
      });
  }

  function invertirRuta() {
    if (coords.length > 1) {
      const start = coords[0];
      const resto = coords.slice(1).reverse();
      coords = [start, ...resto];
      markers.forEach((m) => map.removeLayer(m));
      markers = [];
      coords.slice(1).forEach(([lng, lat]) => {
        markers.push(L.marker([lat, lng]).addTo(map));
      });
      updateStopList();
      drawRoute();
    }
  }

  function updateStopList() {
    const ul = document.getElementById("stopList");
    ul.innerHTML = "";
    coords.slice(1).forEach((coord, i) => {
      ul.innerHTML += `<li>Parada ${i + 1}: [${coord[1].toFixed(
        5
      )}, ${coord[0].toFixed(5)}]</li>`;
    });
  }
</script>

  </body>
</html>
