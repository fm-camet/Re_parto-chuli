<!DOCTYPE html><html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reparto Chuli</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 90%; }
    #controls { padding: 5px; }
    input, button { margin: 5px; padding: 5px; font-size: 16px; }
  </style>
</head>
<body>
  <div id="controls">
    <input type="text" id="addressInput" placeholder="Agregar dirección..." />
    <button onclick="addAddress()">Agregar</button>
  </div>
  <div id="map"></div>  <script>
    const apiKey = 'tu_api_key_openrouteservice';
    let map = L.map('map');
    let userLocation;
    let waypoints = [];
    let markers = [];
    let polyline;

    navigator.geolocation.getCurrentPosition(pos => {
      userLocation = [pos.coords.latitude, pos.coords.longitude];
      map.setView(userLocation, 13);
      L.marker(userLocation).addTo(map).bindPopup('Ubicación actual').openPopup();
      waypoints.push(userLocation);
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    async function addAddress() {
      const input = document.getElementById('addressInput');
      const address = input.value.trim();
      if (!address || waypoints.length >= 10) return;

      try {
        const response = await axios.get(`https://api.openrouteservice.org/geocode/search`, {
          params: { api_key: apiKey, text: address }
        });
        const coords = response.data.features[0].geometry.coordinates;
        const latlng = [coords[1], coords[0]];

        const marker = L.marker(latlng).addTo(map).bindPopup(address);
        markers.push(marker);
        waypoints.push(latlng);

        if (waypoints.length >= 2) drawRoute();
        input.value = '';
      } catch (err) {
        alert('Dirección no encontrada');
      }
    }

    async function drawRoute() {
      if (polyline) map.removeLayer(polyline);
      const coords = waypoints.map(([lat, lng]) => [lng, lat]);

      const body = {
        coordinates: coords,
        format: 'geojson'
      };

      try {
        const response = await axios.post(`https://api.openrouteservice.org/v2/directions/driving-car/geojson`, body, {
          headers: { 'Authorization': apiKey }
        });
        const route = response.data;

        polyline = L.geoJSON(route).addTo(map);
      } catch (err) {
        alert('Error al trazar la ruta');
      }
    }
  </script></body>
</html>
